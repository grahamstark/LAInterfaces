<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Scottish Legal Aid Board Sim, v0.1.0</title>
    <link rel="icon" href="images/favicon.png">
    <link rel="stylesheet" href="css/bisite-bootstrap.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"/>
    <script type='text/javascript' src='js/jquery.js'></script>
    <script type='text/javascript' src='js/jquery.periodicalupdater.js'></script>
    <script type='text/javascript' src='js/jquery.validate.js'></script>
     <!-- bootstrap -->
    <script src="js/bootstrap.bundle.js"></script>
    <!-- vega graphics -->
    <script type="text/javascript" src="js/vega-lite.min.js"></script>
    <script type="text/javascript" src="js/vega.js"></script>
    <script type="text/javascript" src="js/vega-embed.min.js"></script>
    <!-- templates -->
    <script type='text/javascript' src="js/mustache.min.js"></script>
   
</head>
<body class='text-primary p-2'>
    
         <header class="">
        
        <nav class="navbar navbar-expand-lg nav-fill text-bg-primary">
            <span class='display-4 nav-item'><a class='nav-link active' href='https://www.slab.org.uk/'>
                <img src='images/slab-logo.svg' height='120' width='280'/></a></span>
            <span class='display-2 nav-item'>SLAB SIM</span>
        </nav>

        </header>
        <form id='mainform' action="thing" method="POST">       
            <div class='container-fluid'>                 
                <div class='row'><!-- input row -->
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Allowance Levels</legend>
                        <div class="row">                                                                                    
                            <div class="col">                                                    
                                <label for='income_living_allowance' class='form-label'>Living Allowance</label>
                                <input id='income_living_allowance' type='number' name="income_living_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                            <div class="col">                                                    
                                <label for='income_partners_allowance' class='form-label'>Partner's Allowance</label>
                                <input id='income_partners_allowance' type='number' name="income_partners_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                        </div>
                        <div class="row">                                                                                    
                            <div class="col">                                                    
                                <label for='income_other_dependants_allowance' class='form-label'>Other Dependent's Allowance</label>
                                <input id='income_other_dependants_allowance' type='number' name="income_other_dependants_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                            <div class="col">                                                    
                                <label for='income_child_allowance' class='form-label'>Children's Allowance</label>
                                <input id='income_child_allowance' type='number' name="income_child_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                        </div>
                    </fieldset>
            
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Passported Benefits</legend>
                        <div class="form-check">
                            <input class="form-check-input INCOME_SUPPORT_passported" type="checkbox" value="" id="INCOME_SUPPORT_passported" checked="checked"/>
                            <label class="form-check-label INCOME_SUPPORT_passported" for="INCOME_SUPPORT_passported">
                                Income Support
                            </label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported" type="checkbox" value="" id="NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported" checked="checked"/>
                            <label class="form-check-label NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported" for="NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported">
                                Non-Contrib ESA
                            </label>
                          </div> 
                          <div class="form-check">
                            <input class="form-check-input NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported" type="checkbox" value="" id="NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported" checked="checked"/>
                            <label class="form-check-label NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported" for="NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported">
                                Non-Contrib JSA
                            </label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input UNIVERSAL_CREDIT_passported" type="checkbox" value=""  id="UNIVERSAL_CREDIT_passported" checked="checked"/>
                            <label class="form-check-label UNIVERSAL_CREDIT_passported" for="UNIVERSAL_CREDIT_passported" >
                                Universal Credit
                            </label>
                          </div>
                        </fieldset>
                    </fieldset>
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Included Wealth</legend>
                        <div class="form-check">
                            <input class="form-check-input net_financial_wealth" type="checkbox" value="" id="net_financial_wealth" checked="checked"/>
                            <label class="form-check-label net_financial_wealth" for="net_financial_wealth">
                                Net Financial Wealth
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input net_physical_wealth" type="checkbox" value="" id="net_physical_wealth" checked="checked"/>
                            <label class="form-check-label net_physical_wealth" for="net_physical_wealth">
                                Net Physical Wealth
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input net_housing_wealth" type="checkbox" value="" id="net_housing_wealth" checked="checked"/>
                            <label class="form-check-label net_housing_wealth" for="net_housing_wealth">
                                Net Housing Wealth
                            </label>
                        </div>

                    </fieldset>
                    <fieldset class='col border rounded-2 m-1 p-2'>
                        <legend>Income Contributions</legend>
                        <input type="hidden" id="income-contribution-n" name="income-contribution-n" value=""/>
                        <table class="table table-sm table-striped">
                            <caption>Rates in %, bands in &pound;s pw</caption>
                            <thead>
                                <tr>
                                    <th>Rate (%)</th>
                                    <th>Limit (£pa)</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id='income-contribution-rows'>
                            </tbody>
                        </table>
                    </fieldset>

                    <fieldset class='col border rounded-2 m-1 p-2'>
                        <legend>Capital Contributions</legend>
                        <input type="hidden" id="capital-contribution-n" name="capital-contribution-n" value=""/>
                        <table class="table table-sm table-striped">
                            <caption>Rates in %, Limits in &pound;s</caption>
                            <thead>
                                <tr>
                                    <th>Rate (%)</th>
                                    <th>Limit £s</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id='capital-contribution-rows'>
                            </tbody>
                        </table>
                    </fieldset>

                </div> <!-- row -->
                                                
                <div class="row"> <!-- progress bar -->
                    <div class="col"></div>
                    <div class='col-4' id="progress-indicator"></div>
                    <div class="col"></div>
                </div> <!-- output row -->
                
                <fieldset class="row">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col">
                        <ul class="nav">
                            <li class="nav-item  p-2">                      
                                <button  type="button" class='btn btn-secondary ' value='' onclick='submitForm( "reset" )'>Reset</button>
                            </li>
                             <li class="nav-item p-2">                      
                                <button  type="button" class='btn btn-primary ' value='' onclick='submitForm( "run" )'>Run</button>
                            </li>
                        </ul>
                    </div>
                </fieldset> <!-- submission row -->
                
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class='col-4'></div>
                    <div class='col-4 text-center'>
                        <h3>Effects and Costs</h3>
                    </div>
                    <div class='col-4'></div>
                </div>

                <div class="row">
                    <div class='col-1'></div>
                    <div class="col-10"
                                    data-bs-toggle='modal' 
                                    data-bs-target='#crosstab-popup'>
                                    <div id="crosstab"></div>
                    </div>  

                    <div class='col-1'></div>
                </div>
            </div> <!-- container -->
        </form>

        <p class="text-danger">Note: some features are not yet implemented.</p>
        
        <footer>
            <nav class="text-bg-primary text-center position-relative">
            copyright&copy; 2024 SLAB/Virtual Worlds Research/Others | Code released under the <a href='https://mit-license.org/'>MIT Licence</a>
            </nav>
        </footer>

        <div class='modal fade' id='crosstab-popup' tabindex='-1' role='dialog' aria-labelledby='crosstab-label' aria-hidden='true'>
            <div class='modal-dialog modal-lg'  role='document'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='crosstab-table-label'/>Detailed Changes to Entitlements</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div> <!-- header -->
                    <div class='modal-body'>
                        <div id='crosstabtables'></div>
                    </div>
                </div><!-- content -->
            </div> <!--dialog -->
        </div> <!-- big-table modal -->
        <div id="crosstab-popup">
            <p>HELLO</p>
        </div>
<script type='text/javascript'>



var updater;

function drawRunProgress( data ){
    console.log( "data.completed" + data.completed + "data.size" + data.size );
    var pct = Math.trunc(100 * data.completed / data.size);
    var runn = "Model Running";
    var colour = "bg-success";
    if( data.phase == 'health' ){
        runn = "Estimating Health";
        colour = "bg-info";
    }

    var prog = 
        "<p>" + runn + "</p>"+
        "<div class='progress'>"+
        "<div class='progress-bar " + colour +" progress-bar-animated progress-bar-striped' role='progressbar' "+
            "aria-valuenow='" + pct + "' " + 
            "style='width: "+pct+"%' " +
            "aria-valuemin='0' " +
            "aria-valuemax='100'>"+
            pct + "%" +
            "</div> "+
            "</div>";
    console.log( "prog="+prog )
    $("#progress-indicator").html( prog );
}



const GOLDEN_RATIO = 1.618
 
function createDecileBarChart( targetId, result, thumbnail ){
    var height = 300;
    var xtitle = "Deciles";
    var ytitle = "Transfers (£m p.a.)";
    var title = "Changes By Decile"
    if( thumbnail ){
        var height = 70;
        xtitle = "";
        ytitle = "";
        title = "";
    }
    var width = Math.trunc( GOLDEN_RATIO*height);
    var data=[];
    console.log( "deciles" + result.gains_by_decile.toString());
    console.log( "lorenz_pre[2] length" + result.gains_by_decile.length );
    for( var i = 0; i < result.gains_by_decile.length; i++){
        var dec = (i+1);
        data.push( {"decile":dec, "gain":result.gains_by_decile[i] });
    }
    var deciles_vg = {
        "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
        "title": title,
        "width": width,
        "height": height,
        "description": title,
        "data": {"values": data }, // , "post":data_post
        "mark": "bar",
        "encoding":{
            "x": { "type": "ordinal",
                   "field": "decile",
                   "axis":{
                      "title": xtitle
                   }
             },
            "y": { "type": "quantitative",
                   "field": "gain",
                   "axis":{
                      "title": ytitle
                   }
            }
        } // encoding
    }
    console.log( "deciles_vg=" + JSON.stringify(deciles_vg) );

    vegaEmbed( targetId, deciles_vg );
}


const BIG_A = 9999999999.99

function makeTypename( type ){
    return type=='rate' ? 'r' : 'b';
}

function makeId( n, name, type ){
    var typename = makeTypename( type );
    return name + "-" + typename + '-' + n;
}

function makeInput( n, name, type ){
    var typename = makeTypename( type );
    var min=-BIG_A;
    var max=BIG_A;
    var step=1;
    if( type == 'band' ){
        min=0.0;
        max=BIG_A;
    } else if( type=='rate'){
        min=0.0;
        max=100;
        step=0.01;
    }
    var id = makeId( n, name, type );
    return "<input id='"+id+"' name='"+id+"' type='number' min='"+min+"' max='"+max+"' step='"+step+"' value='' class=' w-75' />";
}

function makeAddDel( n, name, isdel ){
    var action = 'add'+name;
    var icon = "bi-plus-circle text-success";
    if(isdel===true){
        action = 'del'+name;
        icon = "bi-dash-circle text-danger";
    }
    return "<span onclick='submitForm(\""+action+"\", "+n+")' ><i class=\""+icon+"\" style=\"font-size: 1rem\"></i></span>";
}

function makeRow( n, name, addDel ){
    const id = name+"-"+n;
    var row = "<tr id='"+id+"'><td>"+makeInput( n, name, 'rate' )+"</td><td>"+makeInput( n, name, 'band' )+"</td><td  class='align-middle'>"+makeAddDel( n, name, false )+"</td>";
    if( addDel ){
        row += "<td class='align-middle'>"+makeAddDel( n, name, true )+"</td>";
    } else {
        row += "<td></td>";
    }
    row += "</tr>";
    // console.log( "made row as |"+row+"|" );
    return row;
}

function insertRow( which, n, name, addRow ){
    $("#"+which ).append( makeRow( n, name, addRow ));
}


function setVal( id, val, def ){
    $( "#"+id ).val( val );
    console.log( "setVal for #%s val=%s def=%s", id, val, def );
    if( val != def ){
        $( "#"+id ).addClass( 'changed');
    } else {
        $( "#"+id ).removeClass( 'changed');
    }
}

function setCheck( id, val, def ){
    $( "#"+id ).prop('checked', val );
    console.log( "setCheck for #%s val=%s def=%s", id, val, def )
    if( val != def ){
        $( "."+id ).addClass( 'changed');
    } else {
        $( "."+id ).removeClass( 'changed');
    }
}

function loadTax( name, rates, bands, defrates, defbands ){
    var nr = rates.length;
    var nb = bands.length;
    // console.log( "nr="+nr + " nb = " + nb );
    $( "#"+name+"-n").val( nr );
    for( var i = 1; i <= nr; i++ ){
        var rp = "#"+name+"-r-"+i;
        $( rp ).val( rates[i-1]);
        var rb = "#"+name+"-b-"+i;
        // if( i == nr ){
        //     $( rb ).hide();            
        // } else {
         $( rb ).val( bands[i-1]);
        //}
    }
}

function initialiseTable( which, rates, bands, defrates, defbands ){
    var n = rates.length;
    var target = which+ "-rows";
    $( "#"+target ).children().remove();
    var addDel = n > 1;
    for( var i = 1; i <= n; i++ ){
        insertRow( target, i, which, addDel );
    }
    loadTax( which, rates, bands, defrates, defbands );
}

function scrapetax( name ){
    var rates = [];
    var bands = [];
    var nrt = "#"+name+"-n";
    // console.log( "count nrt key = " + nrt );
    var nr = parseInt($( nrt ).val());
    // console.log( name + " : got nr as " + nr );
    for( var i = 1; i <= nr; i++ ){
        var rp = "#"+name+"-r-"+i;
        var rb = "#"+name+"-b-"+i;
        rates.push( parseFloat($( rp ).val()));
        //if( i < nr ){ // skip top bands
            var rr = parseFloat($( rb ).val());
            if( Number.isNaN(rr)){
                rr = BIG_A;
            }
            bands.push( rr );
        // }
    }
    // console.log( "rates=" + rates );
    return [rates, bands];
}


function loadParams( params, defaults ){
    setVal( "income_living_allowance", params.income_living_allowance, defaults.income_living_allowance);
    setVal( "income_partners_allowance", params.income_partners_allowance, defaults.income_partners_allowance );
    setVal( "income_other_dependants_allowance", params.income_other_dependants_allowance, defaults.income_other_dependants_allowance );
    setVal( "income_child_allowance", params.income_child_allowance, defaults.income_child_allowance );
    setCheck( 
        "INCOME_SUPPORT_passported", 
        params.INCOME_SUPPORT_passported, 
        defaults.INCOME_SUPPORT_passported );
    setCheck(
        "NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported",
        params.NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported,
        defaults.NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported );
    setCheck( 
        "NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported",
        params.NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported,
        defaults.NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported );
    setCheck(
        "UNIVERSAL_CREDIT_passported",
        params.UNIVERSAL_CREDIT_passported,
        defaults.UNIVERSAL_CREDIT_passported );
    setCheck(
        "net_housing_wealth",
        params.net_housing_wealth,
        defaults.net_housing_wealth );
    setCheck(
        "net_financial_wealth",
        params.net_financial_wealth,
        defaults.net_financial_wealth );
    setCheck(
        "net_physical_wealth",
        params.net_physical_wealth,
        defaults.net_physical_wealth );
    
    initialiseTable( "income-contribution", 
        params.income_contribution_rates, 
        params.income_contribution_limits,
        defaults.income_contribution_rates,
        defaults.income_contribution_limits );
    initialiseTable( "capital-contribution", 
        params.capital_contribution_rates, 
        params.capital_contribution_limits,
        defaults.capital_contribution_rates,
        defaults.capital_contribution_limits );
}

function createMainOutputs( result ){
    console.log( result.crosstab );
    $("#crosstab").html( result.crosstab );
}

function loadFromForm(){
    ic = scrapetax( "income-contribution" )
    cc = scrapetax( "capital-contribution" )

    var data = {
        income_living_allowance: parseFloat($( "#income_living_allowance" ).val()),
        income_partners_allowance: parseFloat($( "#income_partners_allowance" ).val()),
        income_other_dependants_allowance: parseFloat($( "#income_other_dependants_allowance" ).val()),
        income_child_allowance: parseFloat($( "#income_child_allowance" ).val()),
        INCOME_SUPPORT_passported: $('#INCOME_SUPPORT_passported').is(':checked'),
        NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported: $('#NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported').is(':checked'),
        NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported: $('#NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported').is(':checked'),
        UNIVERSAL_CREDIT_passported: $('#UNIVERSAL_CREDIT_passported').is(':checked'),
        net_financial_wealth: $('#net_financial_wealth').is(':checked'),
        net_physical_wealth: $('#net_physical_wealth').is(':checked'),
        net_housing_wealth: $('#net_housing_wealth').is(':checked'),
        income_contribution_rates: ic[0], 
        income_contribution_limits: ic[1],
        capital_contribution_rates: cc[0], 
        capital_contribution_limits: cc[1]
     }

    console.log( "loadFromForm data = %o", data );
    return data;
}

function submitForm( action, target ){
     var url = "/"+action;
     if( target != null ){
        url += "/"+target;
     }
     $("#mainform").validate();
     var dataset = JSON.stringify(loadFromForm());
     console.log( "submitForm; data = %o", dataset );
     $.ajax(
        { url: url,
         method: 'post',
         dataType: 'json',
         contentType: "application/json",
         data: dataset
        }).done(
            function( initialResult ){
                console.log( "submitForm; initialResult%o", initialResult);
                console.log( "target " + target );
                loadParams( initialResult.params, initialResult.defaults );
                switch( action ){
                    case 'run':
                    case 'reset':
                        createMainOutputs( initialResult.output );
                        break;
                    case 'del':
                        break;
                }
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
        );
}

$(document).ready(function(){
        $("mainform").submit(function(e){
                alert('submit intercepted');
                e.preventDefault(e);
        });
        submitForm("reset", null ); // FIXME make this params?
    });

</script>
</body>
</html>
