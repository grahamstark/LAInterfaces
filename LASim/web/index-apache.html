<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <title>Scottish Legal Aid Board Sim, v0.1.0</title>
    <link rel="icon" href="images/favicon.png">
    <link rel="stylesheet" href="css/slab-bootstrap.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"/>
    <script type='text/javascript' src='js/jquery.js'></script>
    <script type='text/javascript' src='js/jquery.periodicalupdater.js'></script>
    <script type='text/javascript' src='js/jquery.validate.js'></script>
     <!-- bootstrap -->
    <script src="js/bootstrap.bundle.js"></script>
    <!-- vega graphics -->
    <script type="text/javascript" src="js/vega-lite.min.js"></script>
    <script type="text/javascript" src="js/vega.js"></script>
    <script type="text/javascript" src="js/vega-embed.min.js"></script>
    <!-- templates -->
    <script type='text/javascript' src="js/mustache.min.js"></script>
    
</head>
<body class='text-primary p-2'>
    
         <header class="">
        
        <nav class="navbar navbar-expand-lg nav-fill text-bg-primary">
            <span class='display-4 nav-item'><a class='nav-link active' href='https://www.slab.org.uk/'>
                <img src='images/slab-logo.svg' height='120' width='280'/></a></span>
            <span class='display-4 nav-item'>Scottish Legal Aid Board Simulator</span>
            <span class='display-6 nav-item'>v1.2 14th August 2025</span>
        </nav>
        
        </header>
        <form id='mainform' action="thing" method="POST">  
            <input type="hidden" name="uuid" id="uuid" value=""/>
            <div class='container-fluid'>
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class='col-4'></div>
                    <div class='col-4 text-center'>
                        <h2>Change The System</h2>
                    </div>
                    <div class='col-4'></div>
                </div> <!-- row -->
                <div class='row justify-content-center text-secondary pt-3 pb-3'><!-- input row -->
                    <div class='col-5'></div>
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Civil or A&amp;A</legend>
                        <select id="systype" name="systype" value='sys_civil' onchange='submitForm( "switch_system", null )' > 
                            <option value="sys_civil">Civil</option>
                            <option value="sys_aa">Advice and Assistance</option>
                        </select>
                    </fieldset>
                    <div class='col-5'></div>
                </div><!-- row -->
                <div class="row">
                    <p class='col fs-5 text-right mb-0 pb-0 mt-0 pt-0 text-muted' id="units_label">Money Amounts in Annual &pound;s</p>
                </div>
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Allowance Levels</legend>
                        <div class="row">                                                                                    
                            <div class="col">                                                    
                                <label for='income_living_allowance' class='form-label'>Living Allowance</label>
                                <input id='income_living_allowance' type='number' name="income_living_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                            <div class="col">                                                    
                                <label for='income_partners_allowance' class='form-label'>Partner's Allowance</label>
                                <input id='income_partners_allowance' type='number' name="income_partners_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                        </div>
                        <div class="row">                                                                                    
                            <div class="col">                                                    
                                <label for='income_other_dependants_allowance' class='form-label'>Other Dependent's Allowance</label>
                                <input id='income_other_dependants_allowance' type='number' name="income_other_dependants_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                            <div class="col">                                                    
                                <label for='income_child_allowance' class='form-label'>Children's Allowance</label>
                                <input id='income_child_allowance' type='number' name="income_child_allowance" min='0' max='200000' value='' step='1' size="12" class='form-control w-50'/>
                            </div>
                        </div>
                    </fieldset>
            
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Passported Benefits</legend>
                        <div class="form-check">
                            <input class="form-check-input INCOME_SUPPORT_passported" type="checkbox" value="" id="INCOME_SUPPORT_passported" checked="checked"/>
                            <label class="form-check-label INCOME_SUPPORT_passported" for="INCOME_SUPPORT_passported">
                                Income Support
                            </label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported" type="checkbox" value="" id="NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported" checked="checked"/>
                            <label class="form-check-label NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported" for="NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported">
                                Non-Contrib ESA
                            </label>
                          </div> 
                          <div class="form-check">
                            <input class="form-check-input NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported" type="checkbox" value="" id="NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported" checked="checked"/>
                            <label class="form-check-label NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported" for="NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported">
                                Non-Contrib JSA
                            </label>
                          </div>
                          <fieldset class="col border text-black m-1 p-2">
                                <div class="form-check">
                                    <input class="form-check-input UNIVERSAL_CREDIT_passported" type="checkbox" value=""  id="UNIVERSAL_CREDIT_passported" checked="checked"/>
                                    <label class="form-check-label UNIVERSAL_CREDIT_passported" for="UNIVERSAL_CREDIT_passported" >
                                        Universal Credit
                                    </label>
                                </div>
                            <legend class="text-primary">UC Max Earnings/Min Income</legend>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="uc_limit_type" 
                                        id="uc_no_limit"  
                                        value="uc_no_limit"
                                        checked='checked'>
                                    <label 
                                        class="form-check-label" 
                                        for="uc_no_limit">
                                      Don't Limit
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="uc_limit_type" 
                                        id="uc_max_income"  
                                        value="uc_max_income">
                                    <label 
                                        class="form-check-label" 
                                        for="uc_max_income">
                                      Maximum Assessed Income
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="uc_limit_type" 
                                        id="uc_min_payment"  
                                        value="uc_min_payment">
                                    <label 
                                        class="form-check-label" 
                                        for="uc_min_payment">
                                      Minimum UC Entitlement
                                    </label>
                                  </div>
                                   <br/>
                                   <legend class="text-primary">Type of Income Used In UC Passport</legend>                                                                                                                                       
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                            type="radio" 
                                            name="uc_use_earnings" 
                                            id="assessed_net_income"  
                                            value="assessed_net_income"
                                            checked='checked'>
                                        <label 
                                            class="form-check-label" 
                                            for="uc_use_earnings">
                                          Legal Aid Assessed Net Income
                                        </label>
                                      </div>
                                      <div class="form-check">
                                        <input class="form-check-input" 
                                            type="radio" 
                                            name="uc_use_earnings" 
                                            id="tapered_uc_earnings"  
                                            value="tapered_uc_earnings">
                                        <label 
                                            class="uc_use_earnings" 
                                            for="uc_max_income">
                                          UC Assessed Earnings - <em>after</em> UC Taper Applied
                                        </label>
                                      </div>
                                      <div class="form-check">
                                        <input class="form-check-input" 
                                            type="radio" 
                                            name="uc_use_earnings" 
                                            id="full_uc_earnings"  
                                            value="full_uc_earnings">
                                        <label 
                                            class="form-check-label" 
                                            for="uc_use_earnings">
                                            UC Assessed Earnings - <em>before</em> UC Taper Applied
                                        </label>
                                      </div>
                                  <br/>
                                  <label for='uc_limit' id='uc_limit_l'  class='form-label'>Amount (£)</label>
                                  <input id='uc_limit' type='number' name="uc_limit" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                  <br/>                                                         
                            </div>
                            </fieldset> <!-- UC fields -->
                        </fieldset> <!-- Passported Fields -->
                    </fieldset> <!-- Top Row -->
                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Included Wealth</legend>
                        <div class="form-check">
                            <input class="form-check-input net_financial_wealth" type="checkbox" value="" id="net_financial_wealth" checked="checked"/>
                            <label class="form-check-label net_financial_wealth" for="net_financial_wealth">
                                Net Financial Wealth
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input net_physical_wealth" type="checkbox" value="" id="net_physical_wealth" checked="checked"/>
                            <label class="form-check-label net_physical_wealth" for="net_physical_wealth">
                                Net Physical Wealth
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input net_housing_wealth" type="checkbox" value="" id="net_housing_wealth" />
                            <label class="form-check-label net_housing_wealth" for="net_housing_wealth">
                                Net Housing Wealth
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input second_homes" type="checkbox" value="" id="second_homes" />
                            <label class="form-check-label second_homes" for="second_homes">
                                Second Homes
                            </label>
                        </div>

                    </fieldset>
                    <fieldset class='col border rounded-2 m-1 p-2'>
                        <legend>Disposable Income Limit and Income Contributions</legend>
                        <input type="hidden" id="income-contribution-n" name="income-contribution-n" value=""/>
                        <table class="table table-sm table-striped">
                            <caption>Rates in %, bands in &pound;s pw</caption>
                            <thead>
                                <tr>
                                    <th id="income_contrib_rate">Rate (%)</th>
                                    <th>Limit (£pa)</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id='income-contribution-rows'>
                            </tbody>
                        </table>
                        <div>
                            <legend class="text-primary">Are Rates fixed or a proportion?</legend>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="income_cont_type" 
                                        id="cont_proportion"  
                                        value="cont_proportion"
                                        checked='checked'>
                                    <label 
                                        class="form-check-label" 
                                        for="uc_no_limit">
                                      Proportion
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="income_cont_type"" 
                                        id="cont_proportion"  
                                        value="cont_proportion">
                                    <label 
                                        class="form-check-label" 
                                        for="uc_max_income">
                                      Fixed Amounts
                                    </label>
                                  </div>
                            </div>
                    </fieldset>

                    <fieldset class='col border rounded-2 m-1 p-2'>
                        <legend>DIsposable Capital Limit and Capital Contributions</legend>
                        <input type="hidden" id="capital-contribution-n" name="capital-contribution-n" value=""/>
                        <table class="table table-sm table-striped">
                            <caption>Rates in %, Limits in &pound;s</caption>
                            <thead>
                                <tr>
                                    <th>Rate (%)</th>
                                    <th>Limit £s</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id='capital-contribution-rows'>
                            </tbody>
                        </table>
                            <div>
                            <legend class="text-primary">Are Rates fixed or a proportion?</legend>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="capital_cont_type" 
                                        id="cont_proportion"  
                                        value="cont_proportion"
                                        checked='checked'>
                                    <label 
                                        class="form-check-label" 
                                        for="uc_no_limit">
                                      Proportion
                                    </label>
                                  </div>
                                  <div class="form-check">
                                    <input class="form-check-input" 
                                        type="radio" 
                                        name="capital_cont_type"" 
                                        id="cont_proportion"  
                                        value="cont_proportion">
                                    <label 
                                        class="form-check-label" 
                                        for="uc_max_income">
                                      Fixed Amounts
                                    </label>
                                  </div>
                            </div>

                    </fieldset>

                </div> <!-- row -->
                <div class="row">
                    <h3>Expenses</h3>
                </div>
                <div class="row">
                   

                    <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Housing</legend>
                        <div>
                            <input onchange='setExpenseFields( "housing", true )' class='form-check-input ' type='checkbox' id='housing_is_flat' />
                            <label class='form-check-label housing_is_flat' for='housing_is_flat'>
                                Treat as Flat Rate?
                            </label>
                            <br/>
                            <label for='housing_v' id='housing_vlabel'  class='form-label'>% Applicable or Absolute amount (£)</label>
                            <input id='housing_v' type='number' name="housing_v" min='0' max='2000' value='' step='0.01' size="8" class='form-control w-50'/>
                            <label for='housing_max' class='form-label'>Maximum Amount (£)</label>
                            <input id='housing_max' type='number' name="housing_max" min='0' max='99999999999' value='' step='1' size="8" class='form-control w-50'/>
                           
                            <div class="form-check">
                                <input class="form-check-input include_mortgage_repayments" type="checkbox" value="" id="include_mortgage_repayments" />
                                <label class="form-check-label include_mortgage_repayments" for="include_mortgage_repayments">
                                    Include Mortgage Capital Repayments in housing costs?
                                </label>
                            </div>
                        
                        </div>
                        </fieldset>
                        
                        <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Childcare</legend>
                        <div>
                            <input onchange='setExpenseFields( "childcare", true )' class='form-check-input ' type='checkbox' id='childcare_is_flat' />
                            <label class='form-check-label childcare_is_flat' for='childcare_is_flat'>
                                Treat as Flat Rate?
                            </label>
                            <br/>
                            <label for='childcare_v' id='childcare_vlabel'  class='form-label'>% Applicable or Absolute amount (£)</label>
                            <input id='childcare_v' type='number' name="childcare_v" min='0' max='2000' value='' step='0.01' size="8" class='form-control w-50'/>
                            <label for='childcare_max' class='form-label'>Maximum Amount (£)</label>
                            <input id='childcare_max' type='number' name="childcare_max" min='0' max='99999999999' value='' step='1' size="8" class='form-control w-50'/>
                        </div>
                        </fieldset>
                        
                        <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Work Expenses</legend>
                        <div>
                            <input onchange='setExpenseFields( "work_expenses", true )' class='form-check-input ' type='checkbox' id='work_expenses_is_flat' />
                            <label class='form-check-label work_expenses_is_flat' for='work_expenses_is_flat'>
                                Treat as Flat Rate?
                            </label>
                            <br/>
                            <label for='work_expenses_v' id='work_expenses_vlabel'  class='form-label'>% Applicable or Absolute amount (£)</label>
                            <input id='work_expenses_v' type='number' name="work_expenses_v" min='0' max='2000' value='' step='0.01' size="8" class='form-control w-50'/>
                            <label for='work_expenses_max' class='form-label'>Maximum Amount (£)</label>
                            <input id='work_expenses_max' type='number' name="work_expenses_max" min='0' max='99999999999' value='' step='1' size="8" class='form-control w-50'/>
                        </div>
                        </fieldset>
                        
                        <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Maintenance</legend>
                        <div>
                            <input onchange='setExpenseFields( "maintenance", true )' class='form-check-input ' type='checkbox' id='maintenance_is_flat' />
                            <label class='form-check-label maintenance_is_flat' for='maintenance_is_flat'>
                                Treat as Flat Rate?
                            </label>
                            <br/>
                            <label for='maintenance_v' id='maintenance_vlabel'  class='form-label'>% Applicable or Absolute amount (£)</label>
                            <input id='maintenance_v' type='number' name="maintenance_v" min='0' max='2000' value='' step='0.01' size="8" class='form-control w-50'/>
                            <label for='maintenance_max' class='form-label'>Maximum Amount (£)</label>
                            <input id='maintenance_max' type='number' name="maintenance_max" min='0' max='99999999999' value='' step='1' size="8" class='form-control w-50'/>
                        </div>
                        </fieldset>
                        
                        <fieldset class="col border text-black m-1 p-2">
                        <legend class="text-primary">Repayments</legend>
                        <div>
                            <input onchange='setExpenseFields( "repayments", true )' class='form-check-input ' type='checkbox' id='repayments_is_flat' />
                            <label class='form-check-label repayments_is_flat' for='repayments_is_flat'>
                                Treat as Flat Rate?
                            </label>
                            <br/>
                            <label for='repayments_v' id='repayments_vlabel'  class='form-label'>% Applicable or Absolute amount (£)</label>
                            <input id='repayments_v' type='number' name="repayments_v" min='0' max='2000' value='' step='0.01' size="8" class='form-control w-50'/>
                            <label for='repayments_max' class='form-label'>Maximum Amount (£)</label>
                            <input id='repayments_max' type='number' name="repayments_max" min='0' max='99999999999' value='' step='1' size="8" class='form-control w-50'/>
                        </div>
                        </fieldset>                    

                            <fieldset class="col border text-black m-1 p-2">
                                <legend class="text-primary">Add-Ons for Family Types</legend>
                                <label 
                                    for='prem_family' 
                                    id='prem_family_l'  class='form-label'>Families with Children</label>
                                <input id='prem_family' type='number' name="prem_family" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                <label 
                                    for='prem_family_lone_parent' 
                                    id='prem_family_lone_parent_l'  class='form-label'>Lone Parents</label>
                                <input id='prem_family_lone_parent' type='number' name="prem_family_lone_parent" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                <label 
                                    for='prem_disabled_child' 
                                    id='prem_disabled_child_l'  class='form-label'>Disabled Child</label>
                                <input id='prem_disabled_child' type='number' name="prem_disabled_child" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                <label 
                                    for='prem_carer_single' 
                                    id='prem_carer_single_l'  class='form-label'>Single Carer</label>
                                <input id='prem_carer_single' type='number' name="prem_carer_single" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                <label 
                                    for='prem_carer_couple' 
                                    id='prem_carer_couple_l'  class='form-label'>Couple Carer</label>
                                <input id='prem_carer_couple' type='number' name="prem_carer_couple" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                <label 
                                    for='prem_disability_single'                                         
                                    id='prem_disability_single_l'  class='form-label'>Single Disabled</label>
                                <input id='prem_disability_single' type='number' name='prem_disablity_single' min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>

                                <label 
                                    for='prem_disability_couple' 
                                    id='prem_disability_couple_l'  class='form-label'>Couple Disabled</label>
                                <input id='prem_disability_couple' type='number' name="prem_disablity_couple" min='0' max='100000' value='' step='0.01' size="8" class='form-control w-50'/>
                                
                            </fieldset>
                        
                </div>

             
                <fieldset class="row border text-black m-1 p-2">

                    <legend class="text-primary">Disregarded Incomes</legend>

                    <div class='col'>
                        <div class="form-check">
                            <input class="form-check-input CHILD_BENEFIT_disregarded" type="checkbox" value="" id="CHILD_BENEFIT_disregarded" />
                            <label class="form-check-label CHILD_BENEFIT_disregarded" for="CHILD_BENEFIT_disregarded">
                                Child Benefit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input STATE_PENSION_disregarded" type="checkbox" value="" id="STATE_PENSION_disregarded" />
                            <label class="form-check-label STATE_PENSION_disregarded" for="STATE_PENSION_disregarded">
                                State Pension
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input BEREAVEMENT_ALLOWANCE_disregarded" type="checkbox" value="" id="BEREAVEMENT_ALLOWANCE_disregarded" />
                            <label class="form-check-label BEREAVEMENT_ALLOWANCE_disregarded" for="BEREAVEMENT_ALLOWANCE_disregarded">
                                Bereavement Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input ARMED_FORCES_COMPENSATION_SCHEME_disregarded" type="checkbox" value="" id="ARMED_FORCES_COMPENSATION_SCHEME_disregarded" />
                            <label class="form-check-label ARMED_FORCES_COMPENSATION_SCHEME_disregarded" for="ARMED_FORCES_COMPENSATION_SCHEME_disregarded">
                                Armed Forces Compensation Scheme
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input WAR_WIDOWS_PENSION_disregarded" type="checkbox" value="" id="WAR_WIDOWS_PENSION_disregarded" />
                            <label class="form-check-label WAR_WIDOWS_PENSION_disregarded" for="WAR_WIDOWS_PENSION_disregarded">
                                War Widows Pension
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input SEVERE_DISABILITY_ALLOWANCE_disregarded" type="checkbox" value="" id="SEVERE_DISABILITY_ALLOWANCE_disregarded" />
                            <label class="form-check-label SEVERE_DISABILITY_ALLOWANCE_disregarded" for="SEVERE_DISABILITY_ALLOWANCE_disregarded">
                                Severe Disability Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input ATTENDANCE_ALLOWANCE_disregarded" type="checkbox" value="" id="ATTENDANCE_ALLOWANCE_disregarded" />
                            <label class="form-check-label ATTENDANCE_ALLOWANCE_disregarded" for="ATTENDANCE_ALLOWANCE_disregarded">
                                Attendance Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input CARERS_ALLOWANCE_disregarded" type="checkbox" value="" id="CARERS_ALLOWANCE_disregarded" />
                            <label class="form-check-label CARERS_ALLOWANCE_disregarded" for="CARERS_ALLOWANCE_disregarded">
                                Carers Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input INDUSTRIAL_INJURY_BENEFIT_disregarded" type="checkbox" value="" id="INDUSTRIAL_INJURY_BENEFIT_disregarded" />
                            <label class="form-check-label INDUSTRIAL_INJURY_BENEFIT_disregarded" for="INDUSTRIAL_INJURY_BENEFIT_disregarded">
                                Industrial Injury Benefit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input INCAPACITY_BENEFIT_disregarded" type="checkbox" value="" id="INCAPACITY_BENEFIT_disregarded" />
                            <label class="form-check-label INCAPACITY_BENEFIT_disregarded" for="INCAPACITY_BENEFIT_disregarded">
                                Incapacity Benefit
                            </label>
                        </div>
                        </div>
                    <div class='col'>
                    <div class="form-check">
                            <input class="form-check-input PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded" type="checkbox" value="" id="PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded" />
                            <label class="form-check-label PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded" for="PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded">
                                Personal Independence Payment Daily Living
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded" type="checkbox" value="" id="PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded" />
                            <label class="form-check-label PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded" for="PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded">
                                Personal Independence Payment Mobility
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input DLA_SELF_CARE_disregarded" type="checkbox" value="" id="DLA_SELF_CARE_disregarded" />
                            <label class="form-check-label DLA_SELF_CARE_disregarded" for="DLA_SELF_CARE_disregarded">
                                Dla Self Care
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input DLA_MOBILITY_disregarded" type="checkbox" value="" id="DLA_MOBILITY_disregarded" />
                            <label class="form-check-label DLA_MOBILITY_disregarded" for="DLA_MOBILITY_disregarded">
                                Dla Mobility
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input EDUCATION_ALLOWANCES_disregarded" type="checkbox" value="" id="EDUCATION_ALLOWANCES_disregarded" />
                            <label class="form-check-label EDUCATION_ALLOWANCES_disregarded" for="EDUCATION_ALLOWANCES_disregarded">
                                Education Allowances
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input FOSTER_CARE_PAYMENTS_disregarded" type="checkbox" value="" id="FOSTER_CARE_PAYMENTS_disregarded" />
                            <label class="form-check-label FOSTER_CARE_PAYMENTS_disregarded" for="FOSTER_CARE_PAYMENTS_disregarded">
                                Foster Care Payments
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input MATERNITY_ALLOWANCE_disregarded" type="checkbox" value="" id="MATERNITY_ALLOWANCE_disregarded" />
                            <label class="form-check-label MATERNITY_ALLOWANCE_disregarded" for="MATERNITY_ALLOWANCE_disregarded">
                                Maternity Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input MATERNITY_GRANT_disregarded" type="checkbox" value="" id="MATERNITY_GRANT_disregarded" />
                            <label class="form-check-label MATERNITY_GRANT_disregarded" for="MATERNITY_GRANT_disregarded">
                                Maternity Grant
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input FUNERAL_GRANT_disregarded" type="checkbox" value="" id="FUNERAL_GRANT_disregarded" />
                            <label class="form-check-label FUNERAL_GRANT_disregarded" for="FUNERAL_GRANT_disregarded">
                                Funeral Grant
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded" type="checkbox" value="" id="ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded" />
                            <label class="form-check-label ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded" for="ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded">
                                Any Other Ni Or State Benefit
                            </label>
                        </div>
                        </div>
                        <div class='col'>
                        <div class="form-check">
                            <input class="form-check-input FRIENDLY_SOCIETY_BENEFITS_disregarded" type="checkbox" value="" id="FRIENDLY_SOCIETY_BENEFITS_disregarded" />
                            <label class="form-check-label FRIENDLY_SOCIETY_BENEFITS_disregarded" for="FRIENDLY_SOCIETY_BENEFITS_disregarded">
                                Friendly Society Benefits
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input GOVERNMENT_TRAINING_ALLOWANCES_disregarded" type="checkbox" value="" id="GOVERNMENT_TRAINING_ALLOWANCES_disregarded" />
                            <label class="form-check-label GOVERNMENT_TRAINING_ALLOWANCES_disregarded" for="GOVERNMENT_TRAINING_ALLOWANCES_disregarded">
                                Government Training Allowances
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded" type="checkbox" value="" id="CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded" />
                            <label class="form-check-label CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded" for="CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded">
                                Contrib Jobseekers Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input GUARDIANS_ALLOWANCE_disregarded" type="checkbox" value="" id="GUARDIANS_ALLOWANCE_disregarded" />
                            <label class="form-check-label GUARDIANS_ALLOWANCE_disregarded" for="GUARDIANS_ALLOWANCE_disregarded">
                                Guardians Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input WIDOWS_PAYMENT_disregarded" type="checkbox" value="" id="WIDOWS_PAYMENT_disregarded" />
                            <label class="form-check-label WIDOWS_PAYMENT_disregarded" for="WIDOWS_PAYMENT_disregarded">
                                Widows Payment
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input WINTER_FUEL_PAYMENTS_disregarded" type="checkbox" value="" id="WINTER_FUEL_PAYMENTS_disregarded" />
                            <label class="form-check-label WINTER_FUEL_PAYMENTS_disregarded" for="WINTER_FUEL_PAYMENTS_disregarded">
                                Winter Fuel Payments
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input WORKING_TAX_CREDIT_disregarded" type="checkbox" value="" id="WORKING_TAX_CREDIT_disregarded" />
                            <label class="form-check-label WORKING_TAX_CREDIT_disregarded" for="WORKING_TAX_CREDIT_disregarded">
                                Working Tax Credit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input CHILD_TAX_CREDIT_disregarded" type="checkbox" value="" id="CHILD_TAX_CREDIT_disregarded" />
                            <label class="form-check-label CHILD_TAX_CREDIT_disregarded" for="CHILD_TAX_CREDIT_disregarded">
                                Child Tax Credit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded" type="checkbox" value="" id="NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded" />
                            <label class="form-check-label NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded" for="NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded">
                                Non Contrib Employment And Support Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input INCOME_SUPPORT_disregarded" type="checkbox" value="" id="INCOME_SUPPORT_disregarded" />
                            <label class="form-check-label INCOME_SUPPORT_disregarded" for="INCOME_SUPPORT_disregarded">
                                Income Support
                            </label>
                        </div>
                    </div>
                    <div class='col'>
                        <div class="form-check">
                            <input class="form-check-input PENSION_CREDIT_disregarded" type="checkbox" value="" id="PENSION_CREDIT_disregarded" />
                            <label class="form-check-label PENSION_CREDIT_disregarded" for="PENSION_CREDIT_disregarded">
                                Pension Credit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input SAVINGS_CREDIT_disregarded" type="checkbox" value="" id="SAVINGS_CREDIT_disregarded" />
                            <label class="form-check-label SAVINGS_CREDIT_disregarded" for="SAVINGS_CREDIT_disregarded">
                                Savings Credit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded" type="checkbox" value="" id="NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded" />
                            <label class="form-check-label NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded" for="NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded">
                                Non Contrib Jobseekers Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input HOUSING_BENEFIT_disregarded" type="checkbox" value="" id="HOUSING_BENEFIT_disregarded" />
                            <label class="form-check-label HOUSING_BENEFIT_disregarded" for="HOUSING_BENEFIT_disregarded">
                                Housing Benefit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input FREE_SCHOOL_MEALS_disregarded" type="checkbox" value="" id="FREE_SCHOOL_MEALS_disregarded" />
                            <label class="form-check-label FREE_SCHOOL_MEALS_disregarded" for="FREE_SCHOOL_MEALS_disregarded">
                                Free School Meals
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input UNIVERSAL_CREDIT_disregarded" type="checkbox" value="" id="UNIVERSAL_CREDIT_disregarded" />
                            <label class="form-check-label UNIVERSAL_CREDIT_disregarded" for="UNIVERSAL_CREDIT_disregarded">
                                Universal Credit
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input OTHER_BENEFITS_disregarded" type="checkbox" value="" id="OTHER_BENEFITS_disregarded" />
                            <label class="form-check-label OTHER_BENEFITS_disregarded" for="OTHER_BENEFITS_disregarded">
                                Other Benefits
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input STUDENT_GRANTS_disregarded" type="checkbox" value="" id="STUDENT_GRANTS_disregarded" />
                            <label class="form-check-label STUDENT_GRANTS_disregarded" for="STUDENT_GRANTS_disregarded">
                                Student Grants
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input STUDENT_LOANS_disregarded" type="checkbox" value="" id="STUDENT_LOANS_disregarded" />
                            <label class="form-check-label STUDENT_LOANS_disregarded" for="STUDENT_LOANS_disregarded">
                                Student Loans
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input COUNCIL_TAX_BENEFIT_disregarded" type="checkbox" value="" id="COUNCIL_TAX_BENEFIT_disregarded" />
                            <label class="form-check-label COUNCIL_TAX_BENEFIT_disregarded" for="COUNCIL_TAX_BENEFIT_disregarded">
                                Council Tax Benefit
                            </label>
                        </div>
                        </div>
                        <div class='col'>
                        <div class="form-check">
                            <input class="form-check-input CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded" type="checkbox" value="" id="CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded" />
                            <label class="form-check-label CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded" for="CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded">
                                Contrib Employment And Support Allowance
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input SCOTTISH_CHILD_PAYMENT_disregarded" type="checkbox" value="" id="SCOTTISH_CHILD_PAYMENT_disregarded" />
                            <label class="form-check-label SCOTTISH_CHILD_PAYMENT_disregarded" for="SCOTTISH_CHILD_PAYMENT_disregarded">
                                Scottish Child Payment
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input CARERS_ALLOWANCE_SUPPLEMENT_disregarded" type="checkbox" value="" id="CARERS_ALLOWANCE_SUPPLEMENT_disregarded" />
                            <label class="form-check-label CARERS_ALLOWANCE_SUPPLEMENT_disregarded" for="CARERS_ALLOWANCE_SUPPLEMENT_disregarded">
                                Scottish Carers Supplement
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input DISCRETIONARY_HOUSING_PAYMENT_disregarded" type="checkbox" value="" id="DISCRETIONARY_HOUSING_PAYMENT_disregarded" />
                            <label class="form-check-label DISCRETIONARY_HOUSING_PAYMENT_disregarded" for="DISCRETIONARY_HOUSING_PAYMENT_disregarded">
                                Discresionary Housing Payment
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input CHILD_DISABILITY_PAYMENT_CARE_disregarded" type="checkbox" value="" id="CHILD_DISABILITY_PAYMENT_CARE_disregarded" />
                            <label class="form-check-label CHILD_DISABILITY_PAYMENT_CARE_disregarded" for="CHILD_DISABILITY_PAYMENT_CARE_disregarded">
                                Scottish Disability Assistance Children Daily Living
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded" type="checkbox" value="" id="CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded" />
                            <label class="form-check-label CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded" for="CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded">
                                Scottish Disability Assistance Children Mobility
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input PENSION_AGE_DISABILITY_disregarded" type="checkbox" value="" id="PENSION_AGE_DISABILITY_disregarded" />
                            <label class="form-check-label PENSION_AGE_DISABILITY_disregarded" for="PENSION_AGE_DISABILITY_disregarded">
                                Scottish Disability Assistance Older People
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input ADP_DAILY_LIVING_disregarded" type="checkbox" value="" id="ADP_DAILY_LIVING_disregarded" />
                            <label class="form-check-label ADP_DAILY_LIVING_disregarded" for="ADP_DAILY_LIVING_disregarded">
                                Scottish Disability Assistance Working Age Daily Living
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input ADP_MOBILITY_disregarded" type="checkbox" value="" id="ADP_MOBILITY_disregarded" />
                            <label class="form-check-label ADP_MOBILITY_disregarded" for="ADP_MOBILITY_disregarded">
                                Scottish Disability Assistance Working Age Mobility
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input BASIC_INCOME_disregarded" type="checkbox" value="" id="BASIC_INCOME_disregarded" />
                            <label class="form-check-label BASIC_INCOME_disregarded" for="BASIC_INCOME_disregarded">
                                Basic Income
                            </label>
                        </div>
                    </div>
                        
                    

                </fieldset>

                <div class="row">
                    <h3 class='text-secondary'>Run Settings</h3>
                    <fieldset class="col-4 border text-black m-1 p-2">
                        <label for='payment_rate' class='form-label'>% Contributions Collected</label>
                        <input id='payment_rate' 
                            type='number' 
                            name="payment_rate" 
                            min='0' 
                            max='100' 
                            value='' 
                            step='1' 
                            size="12" 
                            class='form-control w-50'/>
                    </fieldset>                        
                    <fieldset class="col-4 border text-black m-1 p-2">
                        <legend class="text-primary">Capital Option</legend>
                        <div class="form-check">
                            <input class="form-check-input" 
                                type="radio" 
                                name="wealth_method" 
                                id="imputation"  
                                value="matching"
                                checked='checked'>
                            <label 
                                class="form-check-label" 
                                for="matching">
                            Use matched Data from the Wealth and Assets Survey (WAS) (Default; use this for 2nd homes)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" 
                                type="radio" 
                                name="wealth_method" 
                                id="imputation"  
                                value="imputation">
                            <label 
                                class="form-check-label" 
                                for="imputation">
                            Use Imputations from WAS
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" 
                                type="radio" 
                                name="wealth_method" 
                                id="no_method"  
                                value="no_method">
                            <label 
                                class="form-check-label" 
                                for="no_method">
                            Use FRS Assets Data (Financial Assets Only, much lower than WAS)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" 
                                type="radio" 
                                name="wealth_method" 
                                id="other_method_1"  
                                value="other_method_1">
                            <label 
                                class="form-check-label" 
                                for="other_method_1">
                            Hybrid Method (Financial and Physical Only); higher than raw FRS, lower than WAS.
                            </label>
                        </div>

                    </fieldset>
                    <fieldset class="col-4 border text-black m-1 p-2">
                        <legend class="text-primary">Takeup Correction</legend>
                        <div class="form-check">
                            <input class="form-check-input do_dodgy_takeup_corrections" type="checkbox" value="" id="do_dodgy_takeup_corrections" name="do_dodgy_takeup_corrections"/>
                            <label class="form-check-label do_dodgy_takeup_corrections" for="do_dodgy_takeup_corrections">
                                Make a very crude means-tested benefit take-up correction? (See tech notes).
                            </label>
                        </div>                        
                    </fieldset>
                    <div class="col-4"></div>
                </div>
                <input type='hidden' id='reset_all_if_changed' name='reset_all_if_changed'/>
                <div class="row"> <!-- progress bar -->
                    <div class="col"></div>
                    <div class='col-4' id="progress-indicator"></div>
                    <div class="col"></div>
                </div> 

                <fieldset class="row">
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col"></div>
                    <div class="col">
                        <ul class="nav">
                            <li class="nav-item  p-2">                      
                                <button  type="button" class='btn btn-secondary ' value='' onclick='submitForm( "reset" )'>Reset</button>
                            </li>
                             <li class="nav-item p-2">                      
                                <button  type="button" class='btn btn-primary ' value='' onclick='submitForm( "run" )'>Run</button>
                            </li>
                        </ul>
                    </div>
                </fieldset> <!-- submission row -->

                <div class="row">
                    <p class='col fs-5 text-right mb-0 pb-0 mt-0 pt-0 text-muted'>Money Amounts in Tables are Annual &pound;s</p>
                </div>                
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class='col-4'></div>
                    <div class='col-4 text-center'>
                        <h2>Effects of Your Changes</h2>
                    </div>
                    <div class='col-4'></div>
                </div>
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class='col-5'></div>
                    <div class='col-2 h5'>
                        <a id='xlsxfile' class="link-success" href="">Output in Excel</a>
                    </div>
                    <div class='col-5'></div>
                </div>                 

                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class="col">
                        <h3>Entitlement Crosstab</h3>
                        <div id="crosstab"></div>
                    </div>  
                </div>
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class="col-4">
                        <h3>Summary Table</h3>
                        <div id="summarytable"></div>
                    </div>  
                    <div class="col-8">
                    </div>
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class="col  table-responsive"
                        data-bs-toggle='modal' 
                        data-bs-target='#allcosts-popup'>
                        <h3>Gross Costs (£000s)</h3>
                        <div id="coststable"></div>
                    </div>  <!-- costs col -->
                </div> <!-- row -->
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class="col table-responsive"
                        data-bs-toggle='modal' 
                        data-bs-target='#allcases-popup'>
                        <h3>Cases</h3>
                        <div id="casestable"></div>
                    </div>  <!-- costs col -->
                </div>
                <div class='row justify-content-center text-secondary pt-3 pb-3'>
                    <div class="col table-responsive"
                        data-bs-toggle='modal' 
                        data-bs-target='#allcounts-popup'>
                        <h3>Entitlements</h3>
                        <div id="countstable"></div>
                    </div>  <!-- costs col -->
                </div>
                </form>
            </div> <!-- container -->
        </form>

        <div class='text-right $colour' 
            style='text-align:right'
            data-bs-toggle='modal' 
            data-bs-target='#example-popup-1-1'>XXX</div>

        
        <footer>

            <ul class="nav flex-column">
                <li class="nav-item mb-2">
                    <a class="nav-link p-0 text-muted" href="techdoc/index.html">Technical Doc</a>
                </li>
                <li class="nav-item mb-2">
                    <a class="nav-link p-0 text-muted" href="https://docs.google.com/spreadsheets/d/1ts0Eo4UUCUO_taFyjIUkAyTlcyNJIFRUu5ON3mauK6k/edit?usp=sharing">Task List</a>
                </li>
                <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-muted">... </a></li>
            </ul>
            <nav class="text-bg-primary text-center position-relative">
            copyright&copy; 2024 SLAB/Virtual Worlds Research/Others | Code released under the <a href='https://mit-license.org/'>MIT Licence</a>
            </nav>

        </footer>

        <div id="crosstabexamples"></div>

        <div class='modal fade' id='allcounts-popup' tabindex='-1' role='dialog' aria-labelledby='crosstab-label' aria-hidden='true'>
            <div class='modal-dialog modal-xl'  role='document'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='allcounts-table-label'/>Detailed Changes to Entitlements</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div> <!-- header -->
                    <div class='modal-body'>
                        <div id='allcounts'></div>
                    </div>
                </div><!-- content -->
            </div> <!--dialog -->
        </div> <!-- big-table modal -->
        <div class='modal fade' id='allcosts-popup' tabindex='-1' role='dialog' aria-labelledby='crosstab-label' aria-hidden='true'>
            <div class='modal-dialog modal-xl'  role='document'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='allcosts-table-label'/>Detailed Changes to Cases</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div> <!-- header -->
                    <div class='modal-body'>
                        <div id='allcosts'></div>
                    </div>
                </div><!-- content -->
            </div> <!--dialog -->
        </div> <!-- big-table modal -->
        <div class='modal fade' id='allcases-popup' tabindex='-1' role='dialog' aria-labelledby='crosstab-label' aria-hidden='true'>
            <div class='modal-dialog modal-xl'  role='document'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title' id='allcases-table-label'/>Detailed Changes to Costs</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div> <!-- header -->
                    <div class='modal-body'>
                        <div id='allcases'></div>
                    </div>
                </div><!-- content -->
            </div> <!--dialog -->
        </div> <!-- big-table modal -->
<script type='text/javascript'>

function setExpenseFields( which, ischange ){
    console.log( "setExpenseFields entered for |"+which );
    var isflatkey = "#"+which+"_is_flat";
    var maxkey = "#"+which+"_max";
    var vkey = "#"+which+"_v";
    var vlabelkey = "#"+which+"_vlabel";
    var isflat =  $(isflatkey).is(':checked');
    if( isflat ){
        $(vlabelkey).html( "Amount £s");
        $(vkey).attr({
           "max" : 10000,       
           "min" : 0,
           "step": 1} );
        $(maxkey).prop( 'disabled', 'disabled' );
        if( ischange ){
            $(vkey).val(0);
        }
    } else {
        $(vlabelkey).html( "% Applicable");
        $(vkey).attr({
           "max" : 100,       
           "min" : 0,
           "step": 1} );
        $(maxkey).prop( 'disabled', false );
        if( ischange ){ // default value
            $(vkey).val(100);

        }
    }
}



var updater;

function drawRunProgress( data ){
    console.log( "data.count" + data.count + "data.size" + data.size );
    var pct = Math.trunc(100 * data.count / data.size);
    var runn = "Model Running";
    var colour = "bg-success";
    if( data.phase == 'health' ){
        runn = "Estimating Health";
        colour = "bg-info";
    }

    var prog = 
        "<p>" + runn + "</p>"+
        "<div class='progress'>"+
        "<div class='progress-bar " + colour +" progress-bar-animated progress-bar-striped' role='progressbar' "+
            "aria-valuenow='" + pct + "' " + 
            "style='width: "+pct+"%' " +
            "aria-valuemin='0' " +
            "aria-valuemax='100'>"+
            pct + "%" +
            "</div> "+
            "</div>";
    console.log( "prog="+prog )
    $("#progress-indicator").html( prog );
}



const GOLDEN_RATIO = 1.618
 
function createDecileBarChart( targetId, result, thumbnail ){
    var height = 300;
    var xtitle = "Deciles";
    var ytitle = "Transfers (£m p.a.)";
    var title = "Changes By Decile"
    if( thumbnail ){
        var height = 70;
        xtitle = "";
        ytitle = "";
        title = "";
    }
    var width = Math.trunc( GOLDEN_RATIO*height);
    var data=[];
    console.log( "deciles" + result.gains_by_decile.toString());
    console.log( "lorenz_pre[2] length" + result.gains_by_decile.length );
    for( var i = 0; i < result.gains_by_decile.length; i++){
        var dec = (i+1);
        data.push( {"decile":dec, "gain":result.gains_by_decile[i] });
    }
    var deciles_vg = {
        "$schema": "https://vega.github.io/schema/vega-lite/v3.json",
        "title": title,
        "width": width,
        "height": height,
        "description": title,
        "data": {"values": data }, // , "post":data_post
        "mark": "bar",
        "encoding":{
            "x": { "type": "ordinal",
                   "field": "decile",
                   "axis":{
                      "title": xtitle
                   }
             },
            "y": { "type": "quantitative",
                   "field": "gain",
                   "axis":{
                      "title": ytitle
                   }
            }
        } // encoding
    }
    console.log( "deciles_vg=" + JSON.stringify(deciles_vg) );
    vegaEmbed( targetId, deciles_vg );
}


const BIG_A = 9999999999.99

function makeTypename( type ){
    return type=='rate' ? 'r' : 'b';
}

function makeId( n, name, type ){
    var typename = makeTypename( type );
    return name + "-" + typename + '-' + n;
}

function makeInput( n, name, type, val ){
    var typename = makeTypename( type );
    var min=-BIG_A;
    var max=BIG_A;
    var step=1;
    if( type == 'band' ){
        min=0.0;
        max=BIG_A;
    } else if( type=='rate'){
        min=0.0;
        max=100;
        step=0.01;
    }
    var id = makeId( n, name, type );
    return "<input id='"+id+"' name='"+id+"' type='number' min='"+min+"' max='"+max+"' step='"+step+"' value='"+val+"' class=' w-75' />";
}

function makeAddDel( n, name, isdel ){
    var action = 'add'+name;
    var icon = "bi-plus-circle text-success";
    if(isdel===true){
        action = 'del'+name;
        icon = "bi-dash-circle text-danger";
    }
    return "<span onclick='submitForm(\""+action+"\", "+n+")' ><i class=\""+icon+"\" style=\"font-size: 1rem\"></i></span>";
}

function makeRow( n, name, addDel, r, b ){
    const id = name+"-"+n;
    var row = "<tr id='"+id+"'><td>"+makeInput( n, name, 'rate', r )+"</td><td>"+makeInput( n, name, 'band', b )+"</td><td  class='align-middle'>"+makeAddDel( n, name, false )+"</td>";
    if( addDel ){
        row += "<td class='align-middle'>"+makeAddDel( n, name, true )+"</td>";
    } else {
        row += "<td></td>";
    }
    row += "</tr>";
    // console.log( "made row as |"+row+"|" );
    return row;
}

function insertRow( which, n, name, addRow, r, b ){
    $("#"+which ).append( makeRow( n, name, addRow, r, b ));
}


function setVal( id, val, def ){
    $( "#"+id ).val( val );
    console.log( "setVal for #%s val=%s def=%s", id, val, def );
    if( val != def ){
        $( "#"+id ).addClass( 'changed');
    } else {
        $( "#"+id ).removeClass( 'changed');
    }
}

function setCheck( id, val, def ){
    $( "#"+id ).prop('checked', val );
    console.log( "setCheck for #%s val=%s def=%s", id, val, def );
    if( val != def ){
        $( "."+id ).addClass( 'changed');
    } else {
        $( "."+id ).removeClass( 'changed');
    }
}

function setRadio( id, val, def ){
    $('input[name="'+id+'"][value="'+val+'"]').prop('checked',true);
    console.log( "setRadio for #%s val=%s def=%s", id, val, def );
    if( val != def ){
        $( "."+id ).addClass( 'changed');
    } else {
        $( "."+id ).removeClass( 'changed');
    }
}

function loadTax( name, rates, bands, defrates, defbands ){
    var nr = rates.length;
    var nb = bands.length;
    console.log( "nr="+nr + " nb = " + nb );
    $( "#"+name+"-n").val( nr );
    for( var i = 1; i <= nr; i++ ){
        var rp = "#"+name+"-r-"+i;
        $( rp ).val( rates[i-1]);
        var rb = "#"+name+"-b-"+i;
        $( rb ).val( bands[i-1]);
    }
}

function initialiseTable( which, rates, bands, defrates, defbands ){
    var n = rates.length;
    var nr = rates.length;
    $( "#"+which+"-n").val( nr );
    var target = which+ "-rows";
    console.log( "n = %o rates %o = bands %o =", n, rates, bands );
    $( "#"+target ).children().remove();
    var addDel = n > 1;
    for( var i = 1; i <= n; i++ ){
        insertRow( target, i, which, addDel, rates[i-1], bands[i-1] );
    }
    // loadTax( which, rates, bands, defrates, defbands );
}

function scrapetax( name ){
    var rates = [];
    var bands = [];
    var nrt = "#"+name+"-n";
    console.log( "count nrt key = " + nrt );
    var nr = parseInt($( nrt ).val());
    console.log( name + " : got nr as " + nr );
    for( var i = 1; i <= nr; i++ ){
        var rp = "#"+name+"-r-"+i;
        var rb = "#"+name+"-b-"+i;
        var rpv = $( rp ).val();
        console.log( "scrapetax; looking for "+rp+ " found " + rpv );
        rates.push( parseFloat(rpv));
        var rr = parseFloat($( rb ).val());
        if( Number.isNaN(rr)){
            rr = BIG_A;
        }
        bands.push( rr );
    }
    console.log( "scrapetax: rates=%o bands=%o", rates, bands );
    return [rates, bands];
}


function loadParams( defaults, params ){
    $( "#systype" ).val( params.systype )
    $( "#uuid").val( params.uuid )
    setVal( "income_living_allowance", params.income_living_allowance, defaults.income_living_allowance);
    console.log( "ila=%o def=%o ",params.income_living_allowance, defaults.income_living_allowance );
    setVal( "income_partners_allowance", params.income_partners_allowance, defaults.income_partners_allowance );
    setVal( "income_other_dependants_allowance", params.income_other_dependants_allowance, defaults.income_other_dependants_allowance );
    setVal( "income_child_allowance", params.income_child_allowance, defaults.income_child_allowance );
    setCheck( "include_mortgage_repayments",
        params.include_mortgage_repayments,
        defaults.include_mortgage_repayments )
    setCheck( 
        "INCOME_SUPPORT_passported", 
        params.INCOME_SUPPORT_passported, 
        defaults.INCOME_SUPPORT_passported );
    setCheck(
        "NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported",
        params.NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported,
        defaults.NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported );
    setCheck( 
        "NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported",
        params.NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported,
        defaults.NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported );
    setCheck(
        "UNIVERSAL_CREDIT_passported",
        params.UNIVERSAL_CREDIT_passported,
        defaults.UNIVERSAL_CREDIT_passported );
    setCheck(
        "net_housing_wealth",
        params.net_housing_wealth,
        defaults.net_housing_wealth );
    setCheck(
        "second_homes",
        params.second_homes,
        defaults.second_homes );
    setCheck(
        "net_financial_wealth",
        params.net_financial_wealth,
        defaults.net_financial_wealth );
    setCheck(
        "net_physical_wealth",
        params.net_physical_wealth,
        defaults.net_physical_wealth );
    
    initialiseTable( "income-contribution", 
        params.income_contribution_rates, 
        params.income_contribution_limits,
        defaults.income_contribution_rates,
        defaults.income_contribution_limits );
    initialiseTable( "capital-contribution", 
        params.capital_contribution_rates, 
        params.capital_contribution_limits,
        defaults.capital_contribution_rates,
        defaults.capital_contribution_limits );

    setCheck(
        "housing_is_flat",
        params.housing_is_flat,
        defaults.housing_is_flat );
    setVal( "housing_v", params.housing_v, defaults.housing_v );
    setVal( "housing_max", params.housing_max, defaults.housing_max );

    setCheck(
        "childcare_is_flat",
        params.childcare_is_flat,
        defaults.childcare_is_flat );
    setVal( "childcare_v", params.childcare_v, defaults.childcare_v );
    setVal( "childcare_max", params.childcare_max, defaults.childcare_max );

    setCheck(
        "work_expenses_is_flat",
        params.work_expenses_is_flat,
        defaults.work_expenses_is_flat );
    setVal( "work_expenses_v", params.work_expenses_v, defaults.work_expenses_v );
    setVal( "work_expenses_max", params.work_expenses_max, defaults.work_expenses_max );

    setCheck(
        "maintenance_is_flat",
        params.maintenance_is_flat,
        defaults.maintenance_is_flat );
    setVal( "maintenance_v", params.maintenance_v, defaults.maintenance_v );
    setVal( "maintenance_max", params.maintenance_max, defaults.maintenance_max );

    setCheck(
        "repayments_is_flat",
        params.repayments_is_flat,
        defaults.repayments_is_flat );
    setVal( "repayments_v", params.repayments_v, defaults.repayments_v );
    setVal( "repayments_max", params.repayments_max, defaults.repayments_max );

    setExpenseFields( "housing", false );
    setExpenseFields( "childcare", false );
    setExpenseFields( "work_expenses", false );
    setExpenseFields( "maintenance", false );
    setExpenseFields( "repayments", false );

    setRadio( "uc_limit_type", params.uc_limit_type, defaults.uc_limit_type );
    setVal( "uc_limit", params.uc_limit, defaults.uc_limit );
    setRadio( "uc_use_earnings", params.uc_use_earnings, defaults.uc_use_earnings );

    setVal( "prem_family", params.prem_family, defaults.prem_family );
    setVal( "prem_family_lone_parent", params.prem_family_lone_parent, defaults.prem_family_lone_parent );
    setVal( "prem_disabled_child", params.prem_disabled_child, defaults.prem_disabled_child );
    setVal( "prem_carer_single", params.prem_carer_single, defaults.prem_carer_single );
    setVal( "prem_carer_couple", params.prem_carer_couple, defaults.prem_carer_couple );
    setVal( "prem_disability_single", params.prem_disability_single, defaults.prem_disability_single );
    setVal( "prem_disability_couple", params.prem_disability_couple, defaults.prem_disability_couple );

    setRadio( "income_cont_type", params.income_cont_type, defaults.income_cont_type )
    setRadio( "capital_cont_type", params.capital_cont_type, defaults.capital_cont_type )

    setRadio( "wealth_method", params.wealth_method, defaults.wealth_method )

    setCheck(
        "do_dodgy_takeup_corrections",
        params.do_dodgy_takeup_corrections,
        defaults.do_dodgy_takeup_corrections );
    setCheck(
        "reset_all_if_changed",
        params.reset_all_if_changed,
        defaults.reset_all_if_changed );
    setVal( "payment_rate", params.payment_rate, defaults.payment_rate );

    if(params.systype == 'sys_civil'){
        $( "#income_contrib_rate" ).html( "Rate (%)" );
        $( "#units_label").html( "Money Amounts in Annual &pound;s" )
    } else {
        $( "#income_contrib_rate" ).html( "Contrib &pound;s" );
        $( "#units_label").html( "Money Amounts in Weekly &pound;s" )
    }


    // auto generated benefit exemptions
    setCheck( 
        'INCAPACITY_BENEFIT_disregarded',
        params.INCAPACITY_BENEFIT_disregarded,
        defaults.INCAPACITY_BENEFIT_disregarded );
    setCheck( 
        'CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded',
        params.CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded,
        defaults.CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded );
    setCheck( 
        'WAR_WIDOWS_PENSION_disregarded',
        params.WAR_WIDOWS_PENSION_disregarded,
        defaults.WAR_WIDOWS_PENSION_disregarded );
    setCheck( 
        'FOSTER_CARE_PAYMENTS_disregarded',
        params.FOSTER_CARE_PAYMENTS_disregarded,
        defaults.FOSTER_CARE_PAYMENTS_disregarded );
    setCheck( 
        'BASIC_INCOME_disregarded',
        params.BASIC_INCOME_disregarded,
        defaults.BASIC_INCOME_disregarded );
    setCheck( 
        'WORKING_TAX_CREDIT_disregarded',
        params.WORKING_TAX_CREDIT_disregarded,
        defaults.WORKING_TAX_CREDIT_disregarded );
    setCheck( 
        'FREE_SCHOOL_MEALS_disregarded',
        params.FREE_SCHOOL_MEALS_disregarded,
        defaults.FREE_SCHOOL_MEALS_disregarded );
    setCheck( 
        'DLA_SELF_CARE_disregarded',
        params.DLA_SELF_CARE_disregarded,
        defaults.DLA_SELF_CARE_disregarded );
    setCheck( 
        'GOVERNMENT_TRAINING_ALLOWANCES_disregarded',
        params.GOVERNMENT_TRAINING_ALLOWANCES_disregarded,
        defaults.GOVERNMENT_TRAINING_ALLOWANCES_disregarded );
    setCheck( 
        'UNIVERSAL_CREDIT_disregarded',
        params.UNIVERSAL_CREDIT_disregarded,
        defaults.UNIVERSAL_CREDIT_disregarded );
    setCheck( 
        'STUDENT_LOANS_disregarded',
        params.STUDENT_LOANS_disregarded,
        defaults.STUDENT_LOANS_disregarded );
    setCheck( 
        'CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded',
        params.CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded,
        defaults.CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded );
    setCheck( 
        'NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded',
        params.NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded,
        defaults.NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded );
    setCheck( 
        'CARERS_ALLOWANCE_disregarded',
        params.CARERS_ALLOWANCE_disregarded,
        defaults.CARERS_ALLOWANCE_disregarded );
    setCheck( 
        'INCOME_SUPPORT_disregarded',
        params.INCOME_SUPPORT_disregarded,
        defaults.INCOME_SUPPORT_disregarded );
    setCheck( 
        'HOUSING_BENEFIT_disregarded',
        params.HOUSING_BENEFIT_disregarded,
        defaults.HOUSING_BENEFIT_disregarded );
    setCheck( 
        'COUNCIL_TAX_BENEFIT_disregarded',
        params.COUNCIL_TAX_BENEFIT_disregarded,
        defaults.COUNCIL_TAX_BENEFIT_disregarded );
    setCheck( 
        'CHILD_BENEFIT_disregarded',
        params.CHILD_BENEFIT_disregarded,
        defaults.CHILD_BENEFIT_disregarded );
    setCheck( 
        'STATE_PENSION_disregarded',
        params.STATE_PENSION_disregarded,
        defaults.STATE_PENSION_disregarded );
    setCheck( 
        'PENSION_AGE_DISABILITY_disregarded',
        params.PENSION_AGE_DISABILITY_disregarded,
        defaults.PENSION_AGE_DISABILITY_disregarded );
    setCheck( 
        'CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded',
        params.CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded,
        defaults.CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded );
    setCheck( 
        'NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded',
        params.NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded,
        defaults.NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded );
    setCheck( 
        'CHILD_DISABILITY_PAYMENT_CARE_disregarded',
        params.CHILD_DISABILITY_PAYMENT_CARE_disregarded,
        defaults.CHILD_DISABILITY_PAYMENT_CARE_disregarded );
    setCheck( 
        'ADP_DAILY_LIVING_disregarded',
        params.ADP_DAILY_LIVING_disregarded,
        defaults.ADP_DAILY_LIVING_disregarded );
    setCheck( 
        'ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded',
        params.ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded,
        defaults.ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded );
    setCheck( 
        'MATERNITY_GRANT_disregarded',
        params.MATERNITY_GRANT_disregarded,
        defaults.MATERNITY_GRANT_disregarded );
    setCheck( 
        'FUNERAL_GRANT_disregarded',
        params.FUNERAL_GRANT_disregarded,
        defaults.FUNERAL_GRANT_disregarded );
    setCheck( 
        'PENSION_CREDIT_disregarded',
        params.PENSION_CREDIT_disregarded,
        defaults.PENSION_CREDIT_disregarded );
    setCheck( 
        'SAVINGS_CREDIT_disregarded',
        params.SAVINGS_CREDIT_disregarded,
        defaults.SAVINGS_CREDIT_disregarded );
    setCheck( 
        'SEVERE_DISABILITY_ALLOWANCE_disregarded',
        params.SEVERE_DISABILITY_ALLOWANCE_disregarded,
        defaults.SEVERE_DISABILITY_ALLOWANCE_disregarded );
    setCheck( 
        'INDUSTRIAL_INJURY_BENEFIT_disregarded',
        params.INDUSTRIAL_INJURY_BENEFIT_disregarded,
        defaults.INDUSTRIAL_INJURY_BENEFIT_disregarded );
    setCheck( 
        'ARMED_FORCES_COMPENSATION_SCHEME_disregarded',
        params.ARMED_FORCES_COMPENSATION_SCHEME_disregarded,
        defaults.ARMED_FORCES_COMPENSATION_SCHEME_disregarded );
    setCheck( 
        'GUARDIANS_ALLOWANCE_disregarded',
        params.GUARDIANS_ALLOWANCE_disregarded,
        defaults.GUARDIANS_ALLOWANCE_disregarded );
    setCheck( 
        'STUDENT_GRANTS_disregarded',
        params.STUDENT_GRANTS_disregarded,
        defaults.STUDENT_GRANTS_disregarded );
    setCheck( 
        'CHILD_TAX_CREDIT_disregarded',
        params.CHILD_TAX_CREDIT_disregarded,
        defaults.CHILD_TAX_CREDIT_disregarded );
    setCheck( 
        'EDUCATION_ALLOWANCES_disregarded',
        params.EDUCATION_ALLOWANCES_disregarded,
        defaults.EDUCATION_ALLOWANCES_disregarded );
    setCheck( 
        'OTHER_BENEFITS_disregarded',
        params.OTHER_BENEFITS_disregarded,
        defaults.OTHER_BENEFITS_disregarded );
    setCheck( 
        'FRIENDLY_SOCIETY_BENEFITS_disregarded',
        params.FRIENDLY_SOCIETY_BENEFITS_disregarded,
        defaults.FRIENDLY_SOCIETY_BENEFITS_disregarded );
    setCheck( 
        'PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded',
        params.PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded,
        defaults.PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded );
    setCheck( 
        'BEREAVEMENT_ALLOWANCE_disregarded',
        params.BEREAVEMENT_ALLOWANCE_disregarded,
        defaults.BEREAVEMENT_ALLOWANCE_disregarded );
    setCheck( 
        'ATTENDANCE_ALLOWANCE_disregarded',
        params.ATTENDANCE_ALLOWANCE_disregarded,
        defaults.ATTENDANCE_ALLOWANCE_disregarded );
    setCheck( 
        'PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded',
        params.PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded,
        defaults.PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded );
    setCheck( 
        'WIDOWS_PAYMENT_disregarded',
        params.WIDOWS_PAYMENT_disregarded,
        defaults.WIDOWS_PAYMENT_disregarded );
    setCheck( 
        'DLA_MOBILITY_disregarded',
        params.DLA_MOBILITY_disregarded,
        defaults.DLA_MOBILITY_disregarded );
    setCheck( 
        'MATERNITY_ALLOWANCE_disregarded',
        params.MATERNITY_ALLOWANCE_disregarded,
        defaults.MATERNITY_ALLOWANCE_disregarded );
    setCheck( 
        'WINTER_FUEL_PAYMENTS_disregarded',
        params.WINTER_FUEL_PAYMENTS_disregarded,
        defaults.WINTER_FUEL_PAYMENTS_disregarded );
    setCheck( 
        'CARERS_ALLOWANCE_SUPPLEMENT_disregarded',
        params.CARERS_ALLOWANCE_SUPPLEMENT_disregarded,
        defaults.CARERS_ALLOWANCE_SUPPLEMENT_disregarded );
    setCheck( 
        'ADP_MOBILITY_disregarded',
        params.ADP_MOBILITY_disregarded,
        defaults.ADP_MOBILITY_disregarded );
    setCheck( 
        'DISCRETIONARY_HOUSING_PAYMENT_disregarded',
        params.DISCRETIONARY_HOUSING_PAYMENT_disregarded,
        defaults.DISCRETIONARY_HOUSING_PAYMENT_disregarded );
    setCheck( 
        'SCOTTISH_CHILD_PAYMENT_disregarded',
        params.SCOTTISH_CHILD_PAYMENT_disregarded,
        defaults.SCOTTISH_CHILD_PAYMENT_disregarded );
}

function createMainOutputs( result, xlsxfile ){
    console.log( xlsxfile );
    $("#crosstab").html( result.crosstab );
    $("#summarytable").html( result.summary_table );
    $("#crosstabexamples").html( result.crosstab_examples );
    $("#countstable").html( result.countstable );
    $("#allcounts").html( result.allcounts );
    $("#coststable").html( result.coststable );
    $("#allcosts").html( result.allcosts );
    $("#casestable").html( result.casestable );
    $("#allcases").html( result.allcases );
    $('#xlsxfile').attr('href', xlsxfile );
}

// from: https://stackoverflow.com/questions/105034/how-do-i-create-a-guid-uuid#2117523
function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

function loadFromForm(new_uuid){
    ic = scrapetax( "income-contribution" );
    cc = scrapetax( "capital-contribution" );
    var data = {
        systype: $( "#systype" ).val(),
        uuid: new_uuid, // set this // $( "#uuid" ).val(),
        income_living_allowance: parseFloat($( "#income_living_allowance" ).val()),
        income_partners_allowance: parseFloat($( "#income_partners_allowance" ).val()),
        income_other_dependants_allowance: parseFloat($( "#income_other_dependants_allowance" ).val()),
        income_child_allowance: parseFloat($( "#income_child_allowance" ).val()),
        include_mortgage_repayments: $('#include_mortgage_repayments').is(':checked'),
        INCOME_SUPPORT_passported: $('#INCOME_SUPPORT_passported').is(':checked'),
        NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported: $('#NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_passported').is(':checked'),
        NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported: $('#NON_CONTRIB_JOBSEEKERS_ALLOWANCE_passported').is(':checked'),
        UNIVERSAL_CREDIT_passported: $('#UNIVERSAL_CREDIT_passported').is(':checked'),
        net_financial_wealth: $('#net_financial_wealth').is(':checked'),
        net_physical_wealth: $('#net_physical_wealth').is(':checked'),
        net_housing_wealth: $('#net_housing_wealth').is(':checked'),
        second_homes: $('#second_homes').is(':checked'),
        income_contribution_rates: ic[0], 
        income_contribution_limits: ic[1],
        capital_contribution_rates: cc[0], 
        capital_contribution_limits: cc[1],
        
        housing_is_flat: $('#housing_is_flat').is(':checked'),
        housing_v: parseFloat($('#housing_v').val()),
        housing_max: parseFloat($('#housing_max').val()),


        childcare_is_flat: $('#childcare_is_flat').is(':checked'),
        childcare_v: parseFloat($('#childcare_v').val()),
        childcare_max: parseFloat($('#childcare_max').val()),


        work_expenses_is_flat: $('#work_expenses_is_flat').is(':checked'),
        work_expenses_v: parseFloat($('#work_expenses_v').val()),
        work_expenses_max: parseFloat($('#work_expenses_max').val()),


        maintenance_is_flat: $('#maintenance_is_flat').is(':checked'),
        maintenance_v: parseFloat($('#maintenance_v').val()),
        maintenance_max: parseFloat($('#maintenance_max').val()),


        repayments_is_flat: $('#repayments_is_flat').is(':checked'),
        repayments_v: parseFloat($('#repayments_v').val()),
        repayments_max: parseFloat($('#repayments_max').val()),

        prem_family: parseFloat($('#prem_family').val()),
        prem_family_lone_parent: parseFloat($('#prem_family_lone_parent').val()),
        prem_disabled_child: parseFloat($('#prem_disabled_child').val()),
        prem_carer_single: parseFloat($('#prem_carer_single').val()),
        prem_carer_couple: parseFloat($('#prem_carer_couple').val()),
        prem_disability_single: parseFloat($('#prem_disability_single').val()),
        prem_disability_couple: parseFloat($('#prem_disability_couple').val()),
        uc_limit: parseFloat($('#uc_limit').val()),
        uc_limit_type: $('input[name="uc_limit_type"]:checked').val(),
        uc_use_earnings: $('input[name="uc_use_earnings"]:checked').val(), // $('#uc_use_earnings').is(':checked'),
        wealth_method: $('input[name="wealth_method"]:checked').val(),
        
        income_cont_type: $('input[name="income_cont_type"]:checked').val(),
        capital_cont_type: $('input[name="capital_cont_type"]:checked').val(),

        do_dodgy_takeup_corrections: $('#do_dodgy_takeup_corrections').is(':checked'),
        reset_all_if_changed: $('#reset_all_if_changed').is(':checked'),
        payment_rate: parseFloat($('#payment_rate').val()),
        
        ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded: $('#ANY_OTHER_NI_OR_STATE_BENEFIT_disregarded').is(':checked'),
        ARMED_FORCES_COMPENSATION_SCHEME_disregarded: $('#ARMED_FORCES_COMPENSATION_SCHEME_disregarded').is(':checked'),
        ATTENDANCE_ALLOWANCE_disregarded: $('#ATTENDANCE_ALLOWANCE_disregarded').is(':checked'),
        BASIC_INCOME_disregarded: $('#BASIC_INCOME_disregarded').is(':checked'),
        BEREAVEMENT_ALLOWANCE_disregarded: $('#BEREAVEMENT_ALLOWANCE_disregarded').is(':checked'),
        CARERS_ALLOWANCE_disregarded: $('#CARERS_ALLOWANCE_disregarded').is(':checked'),
        CHILD_BENEFIT_disregarded: $('#CHILD_BENEFIT_disregarded').is(':checked'),
        CHILD_TAX_CREDIT_disregarded: $('#CHILD_TAX_CREDIT_disregarded').is(':checked'),
        CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded: $('#CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded').is(':checked'),
        CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded: $('#CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded').is(':checked'),
        COUNCIL_TAX_BENEFIT_disregarded: $('#COUNCIL_TAX_BENEFIT_disregarded').is(':checked'),
        DISCRETIONARY_HOUSING_PAYMENT_disregarded: $('#DISCRETIONARY_HOUSING_PAYMENT_disregarded').is(':checked'),
        DLA_MOBILITY_disregarded: $('#DLA_MOBILITY_disregarded').is(':checked'),
        DLA_SELF_CARE_disregarded: $('#DLA_SELF_CARE_disregarded').is(':checked'),
        EDUCATION_ALLOWANCES_disregarded: $('#EDUCATION_ALLOWANCES_disregarded').is(':checked'),
        FOSTER_CARE_PAYMENTS_disregarded: $('#FOSTER_CARE_PAYMENTS_disregarded').is(':checked'),
        FREE_SCHOOL_MEALS_disregarded: $('#FREE_SCHOOL_MEALS_disregarded').is(':checked'),
        FRIENDLY_SOCIETY_BENEFITS_disregarded: $('#FRIENDLY_SOCIETY_BENEFITS_disregarded').is(':checked'),
        FUNERAL_GRANT_disregarded: $('#FUNERAL_GRANT_disregarded').is(':checked'),
        GOVERNMENT_TRAINING_ALLOWANCES_disregarded: $('#GOVERNMENT_TRAINING_ALLOWANCES_disregarded').is(':checked'),
        GUARDIANS_ALLOWANCE_disregarded: $('#GUARDIANS_ALLOWANCE_disregarded').is(':checked'),
        HOUSING_BENEFIT_disregarded: $('#HOUSING_BENEFIT_disregarded').is(':checked'),
        INCAPACITY_BENEFIT_disregarded: $('#INCAPACITY_BENEFIT_disregarded').is(':checked'),
        INCOME_SUPPORT_disregarded: $('#INCOME_SUPPORT_disregarded').is(':checked'),
        INDUSTRIAL_INJURY_BENEFIT_disregarded: $('#INDUSTRIAL_INJURY_BENEFIT_disregarded').is(':checked'),
        MATERNITY_ALLOWANCE_disregarded: $('#MATERNITY_ALLOWANCE_disregarded').is(':checked'),
        MATERNITY_GRANT_disregarded: $('#MATERNITY_GRANT_disregarded').is(':checked'),
        NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded: $('#NON_CONTRIB_EMPLOYMENT_AND_SUPPORT_ALLOWANCE_disregarded').is(':checked'),
        NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded: $('#NON_CONTRIB_JOBSEEKERS_ALLOWANCE_disregarded').is(':checked'),
        OTHER_BENEFITS_disregarded: $('#OTHER_BENEFITS_disregarded').is(':checked'),
        PENSION_CREDIT_disregarded: $('#PENSION_CREDIT_disregarded').is(':checked'),
        PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded: $('#PERSONAL_INDEPENDENCE_PAYMENT_DAILY_LIVING_disregarded').is(':checked'),
        PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded: $('#PERSONAL_INDEPENDENCE_PAYMENT_MOBILITY_disregarded').is(':checked'),
        SAVINGS_CREDIT_disregarded: $('#SAVINGS_CREDIT_disregarded').is(':checked'),
        CARERS_ALLOWANCE_SUPPLEMENT_disregarded: $('#CARERS_ALLOWANCE_SUPPLEMENT_disregarded').is(':checked'),
        SCOTTISH_CHILD_PAYMENT_disregarded: $('#SCOTTISH_CHILD_PAYMENT_disregarded').is(':checked'),        
        CHILD_DISABILITY_PAYMENT_CARE_disregarded: $('#CHILD_DISABILITY_PAYMENT_CARE_disregarded').is(':checked'),
        CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded: $('#CHILD_DISABILITY_PAYMENT_MOBILITY_disregarded').is(':checked'),
        PENSION_AGE_DISABILITY_disregarded: $('#PENSION_AGE_DISABILITY_disregarded').is(':checked'),
        ADP_DAILY_LIVING_disregarded: $('#ADP_DAILY_LIVING_disregarded').is(':checked'),
        ADP_MOBILITY_disregarded: $('#ADP_MOBILITY_disregarded').is(':checked'),
        SEVERE_DISABILITY_ALLOWANCE_disregarded: $('#SEVERE_DISABILITY_ALLOWANCE_disregarded').is(':checked'),
        STATE_PENSION_disregarded: $('#STATE_PENSION_disregarded').is(':checked'),
        STUDENT_GRANTS_disregarded: $('#STUDENT_GRANTS_disregarded').is(':checked'),
        STUDENT_LOANS_disregarded: $('#STUDENT_LOANS_disregarded').is(':checked'),
        UNIVERSAL_CREDIT_disregarded: $('#UNIVERSAL_CREDIT_disregarded').is(':checked'),
        WAR_WIDOWS_PENSION_disregarded: $('#WAR_WIDOWS_PENSION_disregarded').is(':checked'),
        WIDOWS_PAYMENT_disregarded: $('#WIDOWS_PAYMENT_disregarded').is(':checked'),
        WINTER_FUEL_PAYMENTS_disregarded: $('#WINTER_FUEL_PAYMENTS_disregarded').is(':checked'),
        WORKING_TAX_CREDIT_disregarded: $('#WORKING_TAX_CREDIT_disregarded').is(':checked'),
     }

    console.log( "loadFromForm data = %o", data );
    return data;
}

function updateProgress( result ){
    console.log( "updateSTB  result.phase = " + result.data.phase );
    switch( result.data.phase ){
        case 'queued':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Run is in the job queue waiting to start.</div>");
            break;
        case 'start-pre':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Run starting: starting pre-run routines.</div>");
            break;
        case 'weights':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Generating sample weights (may take some time..).</div>");
            break;
        case 'disability_eligibility':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Calibrating Disability Benefits.</div>");
            break;
        case 'dumping_frames':
        $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Dumping main results for later analysis.</div>");
            break;
        case 'starting':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Pre-routines completed; run starting.</div>");
            break;
        case 'run':
            drawRunProgress( result.data );
            break;
        case 'do-one-run-end':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>End of main calculations.</div>");
            break;
        case 'results-generation':
            $("#progress-indicator").html( "<div class='alert alert-info' role='alert'>Generating output.</div>");
            break;
        case 'reached-run-end': 
            $("#progress-indicator").html( "<div></div>" );
         case 'na':
            // updater.stop();
            break;  
        default:
            $("#progress-indicator").html( "<div class='alert alert-danger' role='alert'>Problem: run phase "+result.data.phase+".</div>");
            break;                                      
    }
}

// actions that need to sumbit all the fields
const FULL_DATA_ACTIONS = new Set([
    'run',
    'initial_load',
    'addcapital-contribution',
    'delcapital-contribution',
    'addincome-contribution',
    'delincome-contribution' ]); 
const NEW_UUID_ACTIONS = new Set(['run']);

function submitForm( action, target ){
     var url = "/lasim/"+action; // url = "/"+action;
     if( target != null ){
        url += "/"+target;
     }
     var uuid = $('#uuid').val()
     if(NEW_UUID_ACTIONS.has( action )){
        uuid = uuidv4(); // new ident for this run
        $( "#uuid").val( uuid ); // also store it in page
     }
     var systype = $('#systype').val();
     var formdata = 'NOTHING';
     if(FULL_DATA_ACTIONS.has(action)){
        formdata = loadFromForm(uuid);
     }
     data = JSON.stringify({
        params:formdata,
        uuid:uuid,
        systype:systype})
     console.log( "submitForm; action=%o data = %o", action, data );
     $.ajax(
        { url: url,
         method: 'post',
         dataType: 'json',
         contentType: "application/json",
         data: data
        }).done(
        function( resp ){
                console.log( "submitForm; resp %o", resp);
                console.log( "target " + target );
                switch( action ){
                case 'run':
                    // start updater if no immediate output
                    var rdata = { uuid:uuid, systype:systype };       
                    if( resp.response != "output_ready" ){
                        console.log( "starting run and timer");               
                        console.log( "resp" + resp);
                        var uri = '/progress/';
                        updater = $.PeriodicalUpdater('/progress/', {
                            url: uri,         // URL of ajax request
                            cache: false,     // By default, don't allow caching
                            method: 'POST',    // method; get or post
                            data: rdata,  
                            minTimeout: 1000, // starting value for the timeout in milliseconds
                            maxTimeout:64000, // maximum length of time between requests
                            multiplier: 1,    // if set to 2, timerInterval will double each time the response hasn't changed (up to maxTimeout)
                            maxCalls: 0,      // maximum number of calls. 0 = no limit.
                            maxCallsCallback: null, // The callback to execute when we reach our max number of calls
                            autoStop: 0,      // automatically stop requests after this many returns of the same data. 0 = disabled
                            autoStopCallback: null, // The callback to execute when we autoStop
                            cookie: false,    // whether (and how) to store a cookie
                            runatonce: true, // Whether to fire initially or wait
                            verbose: 0        // The level to be logging at: 0 = none; 1 = some; 2 = all
                        }, function( responseFromUpdater, success, xhr, handle) {
                            console.log( "progress: got %o", responseFromUpdater );
                            switch( responseFromUpdater.response ){
                                case 'output_ready':
                                    $("#progress-indicator").html( "<div></div>" );
                                    console.log( "main; loading output" );
                                    loadParams(  
                                        responseFromUpdater.data.default_params,
                                        responseFromUpdater.data.params );                              
                                    createMainOutputs( 
                                        responseFromUpdater.data.html, 
                                        responseFromUpdater.data.xlsxfile);
                                    console.log("stopping updater");

                                    updater.stop();                                    
                                break;
                                case 'has_progress':
                                    updateProgress( responseFromUpdater );
                                break;
                                case 'please_stop':
                                    updater.stop();
                                case 'no_progress':
                                    ;
                                    break;
                           }
                        });
                    } else {
                        createMainOutputs( 
                            resp.data.html, 
                            resp.data.xlsxfile);
                    }
                    break;
                case 'addcapital-contribution':
                case 'delcapital-contribution':
                case 'addincome-contribution':
                case 'delincome-contribution':
                    // !!! note these response names are 
                    // inconsistent with the main ones
                    loadParams(
                        resp.default_params, resp.params );
                    break;          
                case 'reset':
                case 'load':
                case 'initial_load':
                case 'switch_system':
                    // FIXME something to reset parameters
                    // createMainOutputs( result.data );                    
                    loadParams( 
                        resp.data.default_params, 
                        resp.data.params );
                    createMainOutputs( 
                        resp.data.html, 
                        resp.data.xlsxfile);
                    break;
                }
            }
        ).fail(
            function( jqXHR, textStatus, errorThrown ){
                console.log( "failed with " + textStatus + " errorThrown "+errorThrown );
                console.log( "jqXHR.statusCode" + jqXHR.status + " text" + jqXHR.statusText );
            }
        );
}

$(document).ready(function(){
        $("mainform").submit(function(e){ // stop the form from loading on conventional submit
                alert('submit intercepted');
                e.preventDefault(e);
        });
        submitForm("initial_load", null ); // FIXME make this params?
    });

</script>
</body>
</html>
